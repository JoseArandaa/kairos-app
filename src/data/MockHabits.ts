import { type Habit, type HabitCheckin } from "../types";
import { createTime } from "../utils/createMockTime";

/** ISO (YYYY-MM-DD) del día actual en UTC. Ajustá si querés TZ local. */
function todayISO(): string {
  const d = new Date();
  const year = d.getUTCFullYear();
  const month = String(d.getUTCMonth() + 1).padStart(2, "0");
  const day = String(d.getUTCDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

export const mockHabits: Habit[] = [
  {
    id: "h1",
    userId: "u1",
    name: "Beber agua",
    description: "Mantener hidratación durante el día",
    frequency: "daily",
    quantity: 8,
    measure: "vasos",
    streak: 3,
    longestStreak: 10,
    isActive: true,
    createdAt: createTime(8, 0),
    updatedAt: createTime(2, 0),
    category: "Salud",
    color: "#4CAF50",
    icon: "💧",
    reminderTime: "09:00:00",
  },
  {
    id: "h2",
    userId: "u1",
    name: "Leer",
    description: "Lectura diaria para desarrollo personal",
    frequency: "daily",
    quantity: 20,
    measure: "páginas",
    streak: 7,
    longestStreak: 15,
    isActive: true,
    createdAt: createTime(2, 0),
    updatedAt: createTime(2, 0),
    category: "Educación",
    color: "#2196F3",
    icon: "📚",
    reminderTime: "20:00:00",
  },
  {
    id: "h3",
    userId: "u1",
    name: "Ejercicio",
    description: "Actividad física regular",
    frequency: "weekly",
    quantity: 3,
    measure: "veces",
    streak: 1,
    longestStreak: 5,
    isActive: true,
    createdAt: createTime(2, 0),
    updatedAt: createTime(2, 0),
    category: "Fitness",
    color: "#FF9800",
    icon: "💪",
    customDays: [1, 3, 5],
  },
  {
    id: "h4",
    userId: "u1",
    name: "Meditar",
    description: "Práctica de mindfulness diaria",
    frequency: "daily",
    quantity: 10,
    measure: "minutos",
    streak: 4,
    longestStreak: 12,
    isActive: true,
    createdAt: createTime(2, 0),
    updatedAt: createTime(2, 0),
    category: "Bienestar",
    color: "#9C27B0",
    icon: "🧘",
    reminderTime: "07:00:00",
  },
  {
    id: "h5",
    userId: "u1",
    name: "Dormir bien",
    description: "Mantener horario de sueño saludable",
    frequency: "daily",
    quantity: 7,
    measure: "horas",
    streak: 2,
    longestStreak: 9,
    isActive: true,
    createdAt: createTime(2, 0),
    updatedAt: createTime(2, 0),
    category: "Salud",
    color: "#673AB7",
    icon: "😴",
    reminderTime: "22:00:00",
  },
  {
    id: "h6",
    userId: "u1",
    name: "Practicar inglés",
    description: "Mejorar habilidades en idioma extranjero",
    frequency: "weekly",
    quantity: 5,
    measure: "veces",
    streak: 6,
    longestStreak: 14,
    isActive: true,
    createdAt: createTime(2, 0),
    updatedAt: createTime(2, 0),
    category: "Educación",
    color: "#FF5722",
    icon: "🇬🇧",
    customDays: [0, 2, 4, 6],
  },
  {
    id: "h7",
    userId: "u1",
    name: "Escribir diario",
    description: "Reflexión personal y registro de experiencias",
    frequency: "daily",
    quantity: 1,
    measure: "entrada",
    streak: 12,
    longestStreak: 20,
    isActive: true,
    createdAt: createTime(2, 0),
    updatedAt: createTime(2, 0),
    category: "Desarrollo Personal",
    color: "#795548",
    icon: "📝",
    reminderTime: "21:00:00",
  },
];

export const habitCheckins: HabitCheckin[] = [
  {
    id: "c1",
    habitId: "h1",
    date: "2025-08-21",
    completed: true,
    quantity: 8,
    createdAt: createTime(8, 0),
  },
  {
    id: "c2",
    habitId: "h1",
    date: "2025-08-22",
    completed: true,
    quantity: 8,
    createdAt: createTime(2, 0),
  },
  {
    id: "c3",
    habitId: "h1",
    date: "2025-08-23",
    completed: false,
    quantity: 2,
    createdAt: createTime(5, 0),
  },
  {
    id: "c4",
    habitId: "h1",
    date: "2025-08-24",
    completed: true,
    quantity: 9,
    createdAt: createTime(2, 0),
  },
  {
    id: "c5",
    habitId: "h1",
    date: "2025-08-25",
    completed: true,
    quantity: 8,
    createdAt: createTime(1, 0),
  },
  {
    id: "c6",
    habitId: "h1",
    date: "2025-08-26",
    completed: true,
    quantity: 7,
    createdAt: createTime(10, 0),
  },
  {
    id: "c7",
    habitId: "h1",
    date: "2025-08-27",
    completed: false,
    quantity: 0,
    createdAt: createTime(4, 0),
  },
  {
    id: "c8",
    habitId: "h2",
    date: "2025-08-21",
    completed: true,
    quantity: 18,
    createdAt: createTime(2, 0),
  },
  {
    id: "c9",
    habitId: "h2",
    date: "2025-08-22",
    completed: true,
    quantity: 22,
    createdAt: createTime(2, 0),
  },
  {
    id: "c10",
    habitId: "h2",
    date: "2025-08-23",
    completed: true,
    quantity: 20,
    createdAt: createTime(2, 0),
  },
  {
    id: "c11",
    habitId: "h2",
    date: "2025-08-24",
    completed: true,
    quantity: 21,
    createdAt: createTime(2, 0),
  },
  {
    id: "c12",
    habitId: "h2",
    date: "2025-08-25",
    completed: true,
    quantity: 20,
    createdAt: createTime(2, 0),
  },
  {
    id: "c13",
    habitId: "h2",
    date: "2025-08-26",
    completed: true,
    quantity: 22,
    createdAt: createTime(2, 0),
  },
  {
    id: "c14",
    habitId: "h2",
    date: "2025-08-27",
    completed: true,
    quantity: 18,
    createdAt: createTime(2, 0),
  },

  {
    id: "c15",
    habitId: "h3",
    date: "2025-08-21",
    completed: false,
    quantity: 0,
    createdAt: createTime(2, 0),
  },
  {
    id: "c16",
    habitId: "h3",
    date: "2025-08-22",
    completed: true,
    quantity: 1,
    createdAt: createTime(2, 0),
  },
  {
    id: "c17",
    habitId: "h3",
    date: "2025-08-23",
    completed: false,
    quantity: 0,
    createdAt: createTime(2, 0),
  },
  {
    id: "c18",
    habitId: "h3",
    date: "2025-08-24",
    completed: true,
    quantity: 1,
    createdAt: createTime(2, 0),
  },
  {
    id: "c19",
    habitId: "h3",
    date: "2025-08-25",
    completed: false,
    quantity: 0,
    createdAt: createTime(2, 0),
  },
  {
    id: "c20",
    habitId: "h3",
    date: "2025-08-26",
    completed: false,
    quantity: 0,
    createdAt: createTime(2, 0),
  },
  {
    id: "c21",
    habitId: "h3",
    date: "2025-08-27",
    completed: true,
    quantity: 1,
    createdAt: createTime(2, 0),
  },

  {
    id: "c22",
    habitId: "h4",
    date: "2025-08-21",
    completed: true,
    quantity: 10,
    createdAt: createTime(2, 0),
  },
  {
    id: "c23",
    habitId: "h4",
    date: "2025-08-22",
    completed: true,
    quantity: 12,
    createdAt: createTime(2, 0),
  },
  {
    id: "c24",
    habitId: "h4",
    date: "2025-08-23",
    completed: false,
    quantity: 0,
    createdAt: createTime(2, 0),
  },
  {
    id: "c25",
    habitId: "h4",
    date: "2025-08-24",
    completed: true,
    quantity: 10,
    createdAt: createTime(2, 0),
  },
  {
    id: "c26",
    habitId: "h4",
    date: "2025-08-25",
    completed: true,
    quantity: 10,
    createdAt: createTime(2, 0),
  },
  {
    id: "c27",
    habitId: "h4",
    date: "2025-08-26",
    completed: true,
    quantity: 11,
    createdAt: createTime(2, 0),
  },
  {
    id: "c28",
    habitId: "h4",
    date: "2025-08-27",
    completed: false,
    quantity: 0,
    createdAt: createTime(2, 0),
  },

  {
    id: "c29",
    habitId: "h5",
    date: "2025-08-21",
    completed: true,
    quantity: 7,
    createdAt: createTime(2, 0),
  },
  {
    id: "c30",
    habitId: "h5",
    date: "2025-08-22",
    completed: true,
    quantity: 7,
    createdAt: createTime(2, 0),
  },
  {
    id: "c31",
    habitId: "h5",
    date: "2025-08-23",
    completed: true,
    quantity: 7,
    createdAt: createTime(2, 0),
  },
  {
    id: "c32",
    habitId: "h5",
    date: "2025-08-24",
    completed: true,
    quantity: 6,
    createdAt: createTime(2, 0),
  },
  {
    id: "c33",
    habitId: "h5",
    date: "2025-08-25",
    completed: false,
    quantity: 5,
    createdAt: createTime(2, 0),
  },
  {
    id: "c34",
    habitId: "h5",
    date: "2025-08-26",
    completed: true,
    quantity: 7,
    createdAt: createTime(2, 0),
  },
  {
    id: "c35",
    habitId: "h5",
    date: "2025-08-27",
    completed: true,
    quantity: 7,
    createdAt: createTime(2, 0),
  },

  {
    id: "c36",
    habitId: "h6",
    date: "2025-08-21",
    completed: true,
    quantity: 1,
    createdAt: createTime(2, 0),
  },
  {
    id: "c37",
    habitId: "h6",
    date: "2025-08-22",
    completed: false,
    quantity: 0,
    createdAt: createTime(2, 0),
  },
  {
    id: "c38",
    habitId: "h6",
    date: "2025-08-23",
    completed: true,
    quantity: 1,
    createdAt: createTime(2, 0),
  },
  {
    id: "c39",
    habitId: "h6",
    date: "2025-08-24",
    completed: true,
    quantity: 1,
    createdAt: createTime(2, 0),
  },
  {
    id: "c40",
    habitId: "h6",
    date: "2025-08-25",
    completed: false,
    quantity: 0,
    createdAt: createTime(2, 0),
  },
  {
    id: "c41",
    habitId: "h6",
    date: "2025-08-26",
    completed: true,
    quantity: 1,
    createdAt: createTime(2, 0),
  },
  {
    id: "c42",
    habitId: "h6",
    date: "2025-08-27",
    completed: false,
    quantity: 0,
    createdAt: createTime(2, 0),
  },

  {
    id: "c43",
    habitId: "h7",
    date: "2025-08-21",
    completed: true,
    quantity: 1,
    createdAt: createTime(2, 0),
  },
  {
    id: "c44",
    habitId: "h7",
    date: "2025-08-22",
    completed: true,
    quantity: 1,
    createdAt: createTime(2, 0),
  },
  {
    id: "c45",
    habitId: "h7",
    date: "2025-08-23",
    completed: true,
    quantity: 1,
    createdAt: createTime(2, 0),
  },
  {
    id: "c46",
    habitId: "h7",
    date: "2025-08-24",
    completed: false,
    quantity: 0,
    createdAt: createTime(2, 0),
  },
  {
    id: "c47",
    habitId: "h7",
    date: "2025-08-25",
    completed: true,
    quantity: 1,
    createdAt: createTime(2, 0),
  },
  {
    id: "c48",
    habitId: "h7",
    date: "2025-08-26",
    completed: true,
    quantity: 1,
    createdAt: createTime(2, 0),
  },
  {
    id: "c49",
    habitId: "h7",
    date: "2025-08-27",
    completed: true,
    quantity: 1,
    createdAt: createTime(2, 0),
  },
];

export type HabitForHome = {
  id: string;
  name: string;
  completedToday: boolean;
  streak: number;
  longestStreak: number;
  todayQuantity?: number;
  measure?: string;
};

type HabitCheckinType = (typeof habitCheckins)[number];

export function buildHabitsForHome(
  habits: Habit[],
  checkins: HabitCheckinType[],
  overrideTodayISO?: string,
): HabitForHome[] {
  const today = overrideTodayISO ?? todayISO();

  const todayMap = new Map(checkins.filter((c) => c.date === today).map((c) => [c.habitId, c]));

  return habits
    .filter((h) => h.isActive)
    .map((h) => {
      const t = todayMap.get(h.id);
      return {
        id: h.id,
        name: h.name,
        completedToday: !!t?.completed,
        streak: h.streak,
        longestStreak: h.longestStreak,
        todayQuantity: t?.quantity,
        measure: h.measure || undefined,
      };
    });
}
